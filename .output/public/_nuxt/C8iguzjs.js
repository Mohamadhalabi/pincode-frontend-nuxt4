import{C,$ as O,l as Q,x as F,f as b}from"./ClNtL1l2.js";const f="pk:cart",y=m=>m.slug||`${m.product_type}:${m.product_id}`;function N(m,a,u,i){const l=Math.max(1,Number(m||1)),c=Array.isArray(a?.pricing_tiers)?[...a.pricing_tiers]:[];c.sort((n,p)=>(n?.min_qty||1)-(p?.min_qty||1));for(const n of c){const p=Number(n?.min_qty||1),_=n?.max_qty==null?Number.POSITIVE_INFINITY:Number(n.max_qty);if(l>=p&&l<=_)return Number(n?.sale_price_usd??n?.price_usd??0)}return Number(a?.sale_price_usd??i??a?.base_price_usd??a?.price_usd??u??0)}function K(){const a=C().$api,u=O("cart",()=>({loaded:!1,items:[],map:new Map,subtotal:0})),i=()=>!!(localStorage.getItem("auth_token")||localStorage.getItem("pk:token")),l=()=>{try{localStorage.setItem(f,JSON.stringify(u.value.items))}catch{}},c=()=>{const t=u.value.items||[],e=[];for(const r of t)e.push([y(r),r]),r.id!=null&&e.push([String(r.id),r]);u.value.map=new Map(e)},n=()=>{const t=u.value.items||[];u.value.subtotal=t.reduce((e,r)=>e+Number(r.price||0)*Number(r.qty||0),0)};Q(async()=>{if(!u.value.loaded){if(i()&&a)await o(!0);else{try{const t=localStorage.getItem(f),e=t?JSON.parse(t):[];u.value.items=Array.isArray(e)?e:[]}catch{}c(),n()}u.value.loaded=!0}}),F(()=>u.value.items,()=>{c(),l(),n()},{deep:!0});const p=b(()=>u.value.items||[]),_=b(()=>(u.value.items||[]).reduce((t,e)=>t+Number(e.qty||0),0)),h=b(()=>Number(u.value.subtotal||0));function S(t){const e=t?.data&&(Array.isArray(t.data.items)||t.data.subtotal!=null)?t.data:t,r=Array.isArray(e?.items)?e.items:[],s=Number(e?.subtotal??0);return{serverItems:r,serverSubtotal:s}}async function o(t=!1){if(!i()||!a){if(t){try{const e=localStorage.getItem(f);u.value.items=e?JSON.parse(e):[]}catch{u.value.items=[]}c(),n()}return}try{const e=await a("/cart",{method:"GET"}),{serverItems:r,serverSubtotal:s}=S(e);u.value.items=r,u.value.subtotal=s,c()}catch{if(t){try{const e=localStorage.getItem(f);u.value.items=e?JSON.parse(e):[]}catch{u.value.items=[]}c(),n()}}}async function v(){if(!i()||!a)return;const t=g();if(!t.length)return;const e=t.map(r=>({product_id:r.product_id,product_type:r.product_type,qty:Number(r.qty||1),name:r.name,slug:r.slug??null,sku:r.sku??null,price:Number(r.price||0),image:r.image??null,meta:r.meta??null}));try{await a("/cart/merge",{method:"POST",body:{items:e}})}catch{}}async function w(){await v(),await o(!0)}function q(t){const e={qty:1,meta:null,...t,price:Number(t.price||0)},r=y(e),s=u.value.map.get(r);s?(s.qty=Number(s.qty||0)+Number(e.qty||1),s.price=N(s.qty,s.meta,s.meta?.base_price_usd,s.meta?.sale_price_usd)):u.value.items.push({...e,qty:Number(e.qty||1)}),n()}function x(t,e){const r=d(t);r&&(r.qty=Math.max(1,Math.floor(Number(e)||1)),r.price=N(r.qty,r.meta,r.meta?.base_price_usd,r.meta?.sale_price_usd),n())}function A(t){const e=d(t);if(!e)return;const r=(u.value.items||[]).findIndex(s=>s===e);r>=0&&u.value.items.splice(r,1),n()}async function M(t){if(!i()||!a)return q(t);const e={product_id:t.product_id,product_type:t.product_type,slug:t.slug??null,sku:t.sku??null,name:t.name,price:Number(t.price||0),qty:Number(t.qty||1),image:t.image??null,meta:t.meta??null};await a("/cart/items",{method:"POST",body:e}),await o()}function d(t){if(!t)return;if(typeof t=="object")return t;const e=u.value.map.get(String(t));if(e)return e;const r=u.value.items||[];if(typeof t=="string")return r.find(s=>y(s)===t);{const s=Number(t);return r.find(J=>Number(J.id)===s)}}async function T(t,e){if(e=Math.max(1,Math.floor(Number(e)||1)),!i()||!a)return x(t,e);const r=d(t);r&&(await a("/cart/items/update",{method:"POST",body:{product_id:r.product_id,product_type:r.product_type,qty:e}}),await o())}async function I(t){if(!i()||!a)return A(t);const e=d(t);e&&(await a("/cart/items/remove",{method:"POST",body:{product_id:e.product_id,product_type:e.product_type}}),await o())}async function P(){if(!i()||!a){u.value.items.splice(0,u.value.items.length),u.value.subtotal=0,l();return}const t=[...u.value.items||[]];for(const e of t)await a("/cart/items/remove",{method:"POST",body:{product_id:e.product_id,product_type:e.product_type}});await o()}function $(t){u.value.items.splice(0,u.value.items.length,...t),n()}function g(){return(u.value.items||[]).map(t=>({...t,meta:t.meta?{...t.meta}:null}))}function E(){l()}return{items:p,count:_,subtotal:h,add:M,setQty:T,remove:I,clear:P,replace:$,snapshot:g,reload:o,mergeToServer:v,afterAuthSync:w,sync:E,makeKey:y}}export{K as u};
